# Minimal Keycloak Helm Chart - Operator Mode Only
# This chart deploys only the Keycloak CR (Custom Resource)
# All supporting resources (database, secrets, ingress, tunnel binding) are managed by Kyverno policies

# Keycloak Operator configuration
operator:
  enabled: true
  http:
    enabled: true
    tlsSecret: ""
  hostname:
    # For hostname v2, strict disables dynamic hostname resolution
    strict: false
    # backchannelDynamic enables dynamic backchannel URLs (for internal apps)
    backchannelDynamic: false
    # Admin hostname (e.g., https://auth-admin.example.com)
    admin: ""
  # Additional Keycloak server options
  # Note: proxy-headers is handled by keycloak.proxy.mode
  # Removed deprecated hostname v1 options (hostname-port, hostname-strict-https)
  additionalOptions: []

# Number of replicas
replicaCount: 1

# Keycloak admin credentials (managed by Kyverno)
admin:
  username: admin
  password: "changeme"
  existingSecret: true
  existingSecretName: "keycloak-admin-credentials"

# PostgreSQL database configuration (managed by Kyverno)
postgresql:
  provisionDatabase: true
  useDynamicCredentials: true
  clusterName: postgres-ha
  databaseNamespace: database
  database: keycloak
  username: keycloak
  reclaimPolicy: retain
  existingSecret:
    name: keycloak-db-credentials
    usernameKey: username
    passwordKey: password

# Keycloak configuration
keycloak:
  # Override this with your hostname (e.g., https://auth.example.com)
  hostname: ""
  features: []
  # External providers (JARs downloaded at startup via init container)
  # Example in ApplicationSet:
  #   providers:
  #     - name: keycloak-discord
  #       url: https://github.com/wadahiro/keycloak-discord/releases/download/v0.6.1/keycloak-discord-0.6.1.jar
  providers: []
  proxy:
    enabled: true
    mode: xforwarded
  health:
    enabled: true
  metrics:
    enabled: true
  cache:
    type: ispn
    stack: kubernetes
  extraEnv: []
  extraArgs: []

# Resource limits and requests
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 2Gi

# Pod security context
podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsNonRoot: true

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity rules
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: keycloak
          topologyKey: kubernetes.io/hostname

# Pod annotations
podAnnotations: {}

# Service configuration
service:
  type: ClusterIP
  port: 8080

# Ingress configuration
ingress:
  enabled: false
  className: ""
  # Public ingress - for authentication endpoints (exposed via tunnel)
  public:
    enabled: false
    annotations: {}
    hosts: []
    #  - host: auth.example.com
    #    paths:
    #      - path: /realms
    #        pathType: Prefix
    #      - path: /resources
    #        pathType: Prefix
    #      - path: /js
    #        pathType: Prefix
    tls: []
    #  - secretName: keycloak-public-tls
    #    hosts:
    #      - auth.example.com
  # Admin ingress - for admin console (internal only, no tunnel)
  admin:
    enabled: false
    className: ""
    annotations: {}
    hosts: []
    #  - host: auth.local.example.com
    #    paths:
    #      - path: /admin
    #        pathType: Prefix
    #      - path: /realms/master/admin
    #        pathType: Prefix
    tls: []
    #  - secretName: keycloak-admin-tls
    #    hosts:
    #      - auth.local.example.com

# OpenBao integration (managed by Kyverno)
openbao:
  enabled: false
  vaultConnectionRef: "vault-secrets-operator-system/default"
  vaultAuth:
    create: true
    mount: "kubernetes"
    role: "infrastructure"
    tokenExpirationSeconds: 600
