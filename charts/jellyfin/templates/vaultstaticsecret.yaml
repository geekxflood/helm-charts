{{- if .Values.openbao.enabled }}
{{- if .Values.openbao.staticSecret.enabled }}
---
# VaultStaticSecret for Jellyfin credentials from OpenBao KV store
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: {{ include "jellyfin.fullname" . }}-credentials
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "jellyfin.labels" . | nindent 4 }}
spec:
  # Reference to VaultAuth resource
  vaultAuthRef: {{ include "jellyfin.fullname" . }}-auth

  # KV v2 secret engine mount path
  mount: {{ .Values.openbao.staticSecret.mount }}

  # Path to the secret within the mount
  path: {{ .Values.openbao.staticSecret.path }}

  # KV version (kv-v2 for versioned secrets)
  type: kv-v2

  # Destination Kubernetes Secret configuration
  destination:
    create: true
    name: {{ .Values.openbao.staticSecret.secretName | default (printf "%s-vault-secret" (include "jellyfin.fullname" .)) }}
    type: Opaque
    overwrite: true

  # How often to refresh the secret from OpenBao
  refreshAfter: {{ .Values.openbao.staticSecret.refreshAfter | default "1h" }}

  {{- if .Values.openbao.staticSecret.rolloutRestartTargets }}
  # Restart pods when secret changes
  rolloutRestartTargets:
    {{- toYaml .Values.openbao.staticSecret.rolloutRestartTargets | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}
