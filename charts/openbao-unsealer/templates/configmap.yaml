apiVersion: v1
kind: ConfigMap
metadata:
  name: openbao-unsealer-script
  namespace: {{ .Values.openbao.namespace }}
  labels:
    app.kubernetes.io/name: openbao-unsealer
    app.kubernetes.io/instance: {{ .Release.Name }}
data:
  unseal.sh: |
    #!/bin/sh
    set -e

    # Install required tools
    echo "Installing required tools..."
    apk add --no-cache curl kubectl 2>&1 | grep -v "^fetch\|^OK" || true
    echo ""

    echo "=========================================="
    echo "OpenBao Automatic Unsealer"
    echo "=========================================="
    echo ""
    echo "Configuration:"
    echo "  OpenBao Address: $BAO_ADDR"
    echo "  Replicas: $OPENBAO_REPLICAS"
    echo "  Keys to use: $KEYS_TO_USE"
    echo "  Max retries: $MAX_RETRIES"
    echo "  Retry delay: ${RETRY_DELAY}s"
    echo ""

    # Read unseal keys from mounted secret
    UNSEAL_KEYS=""
    for i in $(seq 1 $KEYS_TO_USE); do
      KEY_FILE="/etc/openbao-keys/unseal-key-$i"
      if [ -f "$KEY_FILE" ]; then
        KEY=$(cat "$KEY_FILE")
        UNSEAL_KEYS="$UNSEAL_KEYS $KEY"
        echo "✓ Loaded unseal key $i"
      else
        echo "✗ ERROR: Unseal key $i not found at $KEY_FILE"
        exit 1
      fi
    done
    echo ""

    # Function to get OpenBao pod IPs using kubectl
    get_openbao_pod_ips() {
      kubectl get pods -n {{ .Values.openbao.namespace }} \
        -l app.kubernetes.io/name=openbao \
        -o jsonpath='{range .items[*]}{.status.podIP}{"\n"}{end}' 2>/dev/null || echo ""
    }

    # Function to unseal OpenBao via HTTP API
    unseal_via_api() {
      local retry_count=0
      local pod_ips=""

      echo "Unsealing OpenBao cluster via HTTP API..."
      echo "  Discovering OpenBao pod IPs..."

      # Get pod IPs
      pod_ips=$(get_openbao_pod_ips)
      if [ -z "$pod_ips" ]; then
        echo "  ✗ ERROR: Could not discover OpenBao pod IPs"
        return 1
      fi

      echo "  Found OpenBao pods:"
      echo "$pod_ips" | while read ip; do
        echo "    - $ip"
      done
      echo ""

      while [ $retry_count -lt $MAX_RETRIES ]; do
        echo "  Attempting to unseal OpenBao cluster..." >&2

        # Try each pod IP until one responds
        for pod_ip in $pod_ips; do
          echo "    Trying pod IP: $pod_ip" >&2

          # Check if already unsealed
          STATUS=$(curl -s -m 5 "http://$pod_ip:{{ .Values.openbao.port }}/v1/sys/seal-status" 2>&1)
          echo "    Status response: $STATUS" >&2

          # Check if sealed:false is in the response
          case "$STATUS" in
            *'"sealed":false'*)
              echo "  ✓ OpenBao is already unsealed"
              return 0
              ;;
          esac

          # Submit unseal keys
          for KEY in $UNSEAL_KEYS; do
            RESPONSE=$(curl -s -m 5 -X PUT "http://$pod_ip:{{ .Values.openbao.port }}/v1/sys/unseal" \
              -H "Content-Type: application/json" \
              -d "{\"key\":\"$KEY\"}" 2>&1)
            echo "    Unseal response: $RESPONSE" >&2
          done

          # Check status again
          sleep 1
          STATUS=$(curl -s -m 5 "http://$pod_ip:{{ .Values.openbao.port }}/v1/sys/seal-status" 2>&1)
          echo "    Status after unseal: $STATUS" >&2

          case "$STATUS" in
            *'"sealed":false'*)
              echo "  ✓ OpenBao unsealed successfully"
              return 0
              ;;
          esac
        done

        retry_count=$((retry_count + 1))
        if [ $retry_count -lt $MAX_RETRIES ]; then
          echo "  ⏳ Retry $retry_count/$MAX_RETRIES in ${RETRY_DELAY}s..."
          sleep $RETRY_DELAY
        fi
      done

      echo "  ✗ Failed to unseal OpenBao after $MAX_RETRIES retries"
      return 1
    }

    # Unseal the cluster
    echo "Starting unsealing process..."
    echo ""

    if unseal_via_api; then
      echo ""
      echo "=========================================="
      echo "✓ OpenBao cluster unsealed successfully!"
      echo "=========================================="
      exit 0
    else
      echo ""
      echo "=========================================="
      echo "✗ Failed to unseal OpenBao cluster"
      echo "=========================================="
      exit 1
    fi
